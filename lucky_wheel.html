<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Vòng quay may mắn</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <style>
            * {
                margin: 0;
                font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
            }

            body {
                height: 100vh;
                background: linear-gradient(to right, #1A1A2E, #16213E, #0F3460);
                color: white;
                display: flex;
                flex-direction: column;
            }

            .title {
                text-align: center;
            }

            h1, h3 {
                margin-top: 1rem;
            }

            .container {
                display: flex;
            }

            .input-area, .wheel
            {
                background: linear-gradient(to right, #2D3748, #1A202C);
                margin: 1rem;
                padding: 1rem;
                border-radius: 10px;
                border: 1px solid #4A5568;
                box-shadow: 0 0 10px #4A5568;
            }

            .input-area
            {
                flex: 3 1 0;
            }

            .wheel
            {
                flex: 7 1 0;
            }

            .header {
                background: linear-gradient(to right, #667EEA, #764BA2);
                border-radius: 10px;
                padding: 0.5rem;
                display:flex;
                justify-content:center;
                align-items:center;
                gap: 8px;
            }

            .header h3,
            .header h2 { 
                margin: 0;
                line-height: 1.2;
            }

            .header img {
                height: 24px;
                width: 24px;
            }

            .body
            {
                display: flex;
                flex-direction: column;
            }

            #gift-input {
                color: white;
                background-color: #4A5568;
                border: 2px solid #718096;
                padding: 0.6rem;
                border-radius: 10px;
                margin-top: 1rem;
                cursor: pointer;
            }

            input::placeholder {
                color: white;
                opacity: 1;
            }

            input:focus {
                outline: none;
            }

            .input-group
            {
                display: grid;
                grid-template-columns: 0.5fr 1.5fr;
                gap: 1rem;
            }

            .dropdown
            {
                position: relative;
                transition: 0.5s display ease;
            }

            .dropdown-content
            {
                display: none;
                position: absolute;
                background-color: #4A5568;
                border: 2px solid #718096;
                z-index: 1;
                border-radius: 10px;
                padding: 0.6rem;
                width: 100%;
                top: 100%;
                left: 0;

                opacity: 0;
                transform: translateY(6px) scale(.98);
                visibility: hidden;
                pointer-events: none;
                transition:
                    opacity .45s ease,           /* hiện chậm */
                    transform .45s ease,
                    visibility 0s linear .45s;
            }

            img
            {
                width: 20px;
                height: 20px;
            }

            .dropdown-header
            {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
            }

            .dropdown:hover .dropdown-content
            {
                display: block;
                opacity: 1;
                transform: translateY(0) scale(1);
                visibility: visible;
                pointer-events: auto;
            }

            #add-gift {
                margin-top: 1rem;
                background: linear-gradient(to right, #48BB78, #38A169);
                color: white;
                padding: 0.6rem;
                border-radius: 10px;
                cursor: pointer;
                border: none;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                transition: 0.5s box-shadow ease;
            }

            #add-gift:hover
            {
                box-shadow: 0 6px 18px rgba(72,187,120,.2);                
            }

            .dropdown-item
            {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 0.4rem 0;
            }

            input[type=number]::-webkit-inner-spin-button,
            input[type=number]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .gift-item
            {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(to right, #4A5568, #2D3748);
                border-radius: 10px;
                padding: 0.6rem;
                margin-top: 1rem;
            }

            .gift-list
            {
                margin-top: 1rem;
                max-height: min(40vh, calc(3 * 72px + 2 * 1.6rem + 2 * 1rem));
                overflow-y: auto;
                overscroll-behavior: contain;
                -webkit-overflow-scrolling: touch;
                scrollbar-gutter: stable;
            }

            .gift-container
            {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 0.6rem;
            }

            .info
            {
                display: flex;
                flex-direction: column;
                gap: 0.4rem;
            }

            .gift-item-name
            {
                font-size: 1rem;
                font-weight: bold;
            }

            .gift-item-percentage
            {
                font-size: 0.8rem;
                color: #9CA3AF;
            }

            .gift-item-percentage-value
            {
                font-weight: bold;
                color: #FFD700;
            }

            .delete-gift
            {
                background-color: transparent;
                color: white;
                padding: 0.6rem;
                border-radius: 10px;
                cursor: pointer;
                border: none;
                box-shadow: 0 0 0 rgba(0,0,0,0);
                transition: background-color .3s ease,box-shadow .5s ease;
            }

            .delete-gift:hover
            {
                background-color: #F87171;
                box-shadow: 0 6px 18px rgba(248,113,113,.2);
            }

            .wheel-body {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 2rem;
                position: relative;
            }

            #spin-btn {
                position: absolute;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: linear-gradient(to left, #FFD700, #f5ae33);
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
                border: 4px solid #ffd500;
                cursor: pointer;
                z-index: 10;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }

            #spin-btn:active {
                transform: scale(0.95);
            }

            #lucky-wheel {
                transition: transform 5s ease-out;
            }

            /* Toasts */
            #toast-container {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9999;
            }

            .toast {
            min-width: 280px;
            max-width: 360px;
            background: #f87171;
            border: 1px solid #4a5568;
            color: #fff;
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            animation: slideIn 250ms ease-out;
            }

            .toast.success { border-color: #16a34a; background-color: #34d399; box-shadow: 0 10px 20px rgba(22,163,74,0.25); }
            .toast.error   { border-color: #ef4444; background-color: #f87171; box-shadow: 0 10px 20px rgba(239,68,68,0.25); }
            .toast.info    { border-color: #60a5fa; background-color: #2d3748; box-shadow: 0 10px 20px rgba(96,165,250,0.25); }

            .toast .icon { font-size: 18px; opacity: 0.95; }
            .toast.success .icon { color: #2d3748; }
            .toast.error .icon   { color: #2d3748; }
            .toast.info .icon    { color: #93c5fd; }

            .toast .msg { font-size: 14px; line-height: 1.35; }

            .toast .actions {
            display: flex;
            gap: 8px;
            }

            .toast .btn {
            background: transparent;
            color: #fff;
            border: 1px solid #6b7280;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
            }
            .toast .btn.confirm { border-color: #34d399; }
            .toast .btn.cancel  { border-color: #f87171; }

            @keyframes slideIn {
            from { opacity: 0; transform: translateX(12px); }
            to   { opacity: 1; transform: translateX(0); }
            }

            .gift-list::-webkit-scrollbar { width: 8px; }
            .gift-list::-webkit-scrollbar-thumb {
                background: rgba(255,255,255,.25);
                border-radius: 8px;
            }
            .gift-list { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.25) transparent; }

            .total-percentage-container
            {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 1rem;
                border: 1px solid #4A5568;
                border-radius: 10px;
                padding: 1rem;
                box-shadow: 0 0 20px rgba(96,165,250,0.25);
            }

            #reset-btn
            {
                background: #f87171;
                border: none;
                cursor: pointer;
                color: white;
                padding: 0.6rem;
                border-radius: 10px;
                font-weight: bold;
                transition: 0.5s box-shadow ease;
            }

            #reset-btn:hover
            {
                box-shadow: 0 6px 18px rgba(248,113,113,.2);
            }
        
            .pointer {
                position: absolute;
                top: -28px;
                left: 50%;
                transform: translateX(-50%);
                width: 46px;
                height: 58px;
                z-index: 20;
                pointer-events: none;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,.35));
                animation: pointerFloat 2.4s ease-in-out infinite;
            }
            .pointer svg {
                transform: rotate(180deg);
                display: block;
            }
            @keyframes pointerFloat {
                0%   { transform: translateX(-50%) translateY(0); }
                50%  { transform: translateX(-50%) translateY(2px); }
                100% { transform: translateX(-50%) translateY(0); }
            }
            /* During spinning, make the pointer subtly glow */
            .pointer.spinning {
                animation: none;
                filter: drop-shadow(0 0 10px rgba(255,215,0,.45));
            }

        </style>
    </head>
    <body>
        <div id="toast-container" aria-live="polite"></div>
        <div class="title">
            <h1>Vòng quay may mắn</h1>
            <h3>Chào mừng bạn đến với vòng quay may mắn</h3>
        </div>
        <div class="container">
            <div class="input-area">
                <div class="header">
                    <img src="gift.png" alt="Hộp quà">
                    <h3>Quản Lý Quà Tặng</h3>
                </div>

                <div class="body">
                    <input type="text" placeholder="Nhập tên quà..." id="gift-input" class="gift-name">
                    <div class="input-group">
                        <input type="number" placeholder="Tỷ lệ %" id="gift-input" class="gift-percentage">
                        <div class="dropdown" id="gift-input" class="gift-type">
                            <div class="dropdown-header">
                                <p>Vật phẩm</p>
                                <i class="fa fa-chevron-down"></i>
                            </div>
                            <div class="dropdown-content">
                                <div class="dropdown-item">
                                    <img src="icons8-voucher-20.png" alt="">
                                    <p>Thẻ giảm giá</p>
                                </div>
                                <div class="dropdown-item">
                                    <img src="mobile.png" alt="">
                                    <p>Điện thoại</p>
                                </div>
                                <div class="dropdown-item">
                                    <img src="icons8-other-20.png" alt="">
                                    <p>Khác</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="add-gift"><i class="fa fa-plus" aria-hidden="true"></i> <strong>Thêm món quà</strong></button>
                    <div class="line"></div>
                    <div class="gift-list"></div>
                    <div class="total-percentage-container">
                        <div class="info">
                            <p style="color: #A0AEC0;">Tổng tỷ lệ: </p>
                            <span id="total-percentage" class="gift-item-percentage-value"></span>
                        </div>
                        <button id="reset-btn">Reset</button>
                    </div>
                </div>
            </div>
            <div class="wheel">
                <div class="header">
                    <h2>Vòng quay may mắn</h2>
                </div>
                <div class="wheel-body">
                    <div class="pointer" aria-hidden="true">
                        <!-- Glossy arrow pointer SVG -->
                        <svg width="46" height="58" viewBox="0 0 46 58" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <defs>
                            <linearGradient id="goldGrad" x1="0" y1="0" x2="0" y2="1">
                              <stop offset="0%" stop-color="#FFE27A"/>
                              <stop offset="55%" stop-color="#FFC300"/>
                              <stop offset="100%" stop-color="#B58100"/>
                            </linearGradient>
                            <linearGradient id="shineGrad" x1="0" y1="0" x2="1" y2="0">
                              <stop offset="0%" stop-color="rgba(255,255,255,0.9)"/>
                              <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
                            </linearGradient>
                            <filter id="drop" x="-50%" y="-50%" width="200%" height="200%">
                              <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
                              <feOffset in="blur" dx="0" dy="2" result="off"/>
                              <feMerge>
                                <feMergeNode in="off"/>
                                <feMergeNode in="SourceGraphic"/>
                              </feMerge>
                            </filter>
                          </defs>
                          <!-- Body -->
                          <path d="M23 2 L42 32 C42.7 33.1 42 34.6 40.7 34.6 H31.5 L31.5 47.5 C31.5 49.4 30 51 28.1 51 H17.9 C16 51 14.5 49.4 14.5 47.5 V34.6 H5.3 C4 34.6 3.3 33.1 4 32 L23 2 Z"
                                fill="url(#goldGrad)" stroke="#7A4C00" stroke-width="2" filter="url(#drop)"/>
                          <!-- Shine -->
                          <path d="M23 6 L37 30 H30 C28 23 22 13 16 10 L23 6 Z" fill="url(#shineGrad)" opacity="0.45"/>
                          <!-- Screws -->
                          <circle cx="16" cy="45" r="2.2" fill="#E6C56F" stroke="#7A4C00" stroke-width="1"/>
                          <circle cx="30" cy="45" r="2.2" fill="#E6C56F" stroke="#7A4C00" stroke-width="1"/>
                        </svg>
                    </div>
                    <canvas id="lucky-wheel" width="500" height="500"></canvas>
                    <button id="spin-btn">Quay</button>
                    <label style="position:absolute; bottom:-36px; right:0; font-size:12px; display:flex; align-items:center; gap:6px;"><input type="checkbox" id="mute-audio"> Tắt âm</label>
                </div>
            </div>
        </div>

        <script>
            // ===== Toast helpers =====
            function showToast(message, type = 'success', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    const iconClass = type === 'error' ? 'fa-circle-xmark'
                                    : type === 'info'  ? 'fa-circle-info'
                                    : 'fa-circle-check';
                    toast.innerHTML = `
                    <i class="icon fa-solid ${iconClass}"></i>
                    <div class="msg">${message}</div>
                    <div></div>
                    `;
                    container.appendChild(toast);
                    const timer = setTimeout(() => remove(), duration);

                    function remove() {
                    if (!toast.isConnected) return;
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(12px)';
                    setTimeout(() => toast.remove(), 150);
                    }
                    // click để đóng sớm
                    toast.addEventListener('click', remove);
                    return { remove };
                }

                function showConfirmToast(message, {
                    confirmText = 'Tiếp tục',
                    cancelText = 'Hủy',
                    type = 'info'
                } = {}) {
                    return new Promise(resolve => {
                    const container = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `
                        <i class="icon fa-solid fa-circle-question"></i>
                        <div class="msg">${message}</div>
                        <div class="actions">
                        <button class="btn cancel">${cancelText}</button>
                        <button class="btn confirm">${confirmText}</button>
                        </div>
                    `;
                    container.appendChild(toast);

                    const cleanup = (val) => {
                        if (!toast.isConnected) return;
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(12px)';
                        setTimeout(() => toast.remove(), 150);
                        resolve(val);
                    };

                    toast.querySelector('.confirm').addEventListener('click', () => cleanup(true));
                    toast.querySelector('.cancel').addEventListener('click',  () => cleanup(false));
                    });
                }

                
                // =========================
                // ÂM THANH (WebAudio)
                // =========================
                let audioCtx = null;
                let globalMuted = false;

                function ensureAudioCtx() {
                    if (!audioCtx) {
                        const AC = window.AudioContext || window.webkitAudioContext;
                        audioCtx = new AC();
                    }
                    if (audioCtx.state === 'suspended') {
                        audioCtx.resume();
                    }
                }

                function makeGain(val=0.2) {
                    const g = audioCtx.createGain();
                    g.gain.value = val;
                    g.connect(audioCtx.destination);
                    return g;
                }

                function beep({freq=800, duration=0.06, type='square', gain=0.15}={}) {
                    if (globalMuted) return;
                    ensureAudioCtx();
                    const now = audioCtx.currentTime;
                    const osc = audioCtx.createOscillator();
                    const g = makeGain(gain);
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, now);
                    osc.connect(g);
                    // envelope: quick attack, short decay
                    g.gain.setValueAtTime(g.gain.value, now);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                    osc.start(now);
                    osc.stop(now + duration + 0.02);
                }

                function sweep({from=300, to=1500, duration=0.35, type='sawtooth', gain=0.07}={}) {
                    if (globalMuted) return;
                    ensureAudioCtx();
                    const now = audioCtx.currentTime;
                    const osc = audioCtx.createOscillator();
                    const g = makeGain(gain);
                    osc.type = type;
                    osc.frequency.setValueAtTime(from, now);
                    osc.frequency.exponentialRampToValueAtTime(to, now + duration);
                    osc.connect(g);
                    g.gain.setValueAtTime(gain, now);
                    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                    osc.start(now);
                    osc.stop(now + duration + 0.05);
                }

                function jingleWin() {
                    if (globalMuted) return;
                    ensureAudioCtx();
                    const now = audioCtx.currentTime;
                    const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                    notes.forEach((f, i) => {
                        const start = now + i * 0.12;
                        const osc = audioCtx.createOscillator();
                        const g = makeGain(0.10);
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(f, start);
                        g.gain.setValueAtTime(0.10, start);
                        g.gain.exponentialRampToValueAtTime(0.0001, start + 0.18);
                        osc.connect(g);
                        osc.start(start);
                        osc.stop(start + 0.22);
                    });
                }
// =========================
                // Biến & DOM có sẵn
                // =========================
                const items = document.querySelectorAll('.dropdown-item');
                const item_header = document.querySelector('.dropdown-header');
                const add_gift_button = document.getElementById('add-gift');
                const gift_list = document.querySelector('.gift-list');
                const reset_gift_button = document.getElementById('reset-btn');
                const pointerEl = document.querySelector('.pointer');
                // Audio mute toggle
                const muteChk = document.getElementById('mute-audio');
                if (muteChk) {
                    muteChk.addEventListener('change', () => {
                        globalMuted = muteChk.checked;
                        if (!globalMuted) {
                            // Wake up audio context on unmute
                            try { ensureAudioCtx(); } catch {}
                        }
                    });
                }


                // Canvas wheel
                // === HiDPI canvas fix ===
                function setupHiDPICanvas(canvas, cssSize = 500) {
                    // Keep CSS size fixed for layout
                    canvas.style.width = cssSize + 'px';
                    canvas.style.height = cssSize + 'px';

                    const ratio = window.devicePixelRatio || 1;

                    // Set actual pixel buffer to device pixels
                    canvas.width  = Math.floor(cssSize * ratio);
                    canvas.height = Math.floor(cssSize * ratio);

                    const ctx = canvas.getContext('2d');
                    // Scale the drawing coordinate system so we can keep using CSS pixel units
                    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
                    return { ctx, cssSize };
                }

                                const canvas = document.getElementById('lucky-wheel');
                const { ctx, cssSize } = setupHiDPICanvas(canvas);
                let cx = cssSize / 2;
                let cy = cssSize / 2;
                let R  = Math.min(cx, cy) - 6;

                // Pointer ở đỉnh → góc mục tiêu là -PI/2
                const POINTER_ANGLE = -Math.PI / 2;

                // Dữ liệu quà
                let percentage = 0;
                let gifts = [
                    {
                        name: 'Thẻ giảm giá 100 nghìn',
                        percentage: 10,
                        type: 'Thẻ giảm giá'
                    },
                    {
                        name: 'Thẻ giảm giá 200 nghìn',
                        percentage: 20,
                        type: 'Thẻ giảm giá'
                    },
                    {
                        name: 'Thẻ giảm giá 500 nghìn',
                        percentage: 5,
                        type: 'Thẻ giảm giá'
                    },
                    {
                        name: 'IPhone 16 Promax 512GB',
                        percentage: 1,
                        type: 'Điện thoại'
                    },
                    {
                        name: 'Chúc bạn may mắn lần sau',
                        percentage: 64,
                        type: 'Khác'
                    }
                ];
                // Góc quay hiện tại
                let rotation = 0;

                // =========================
                // UI chọn loại quà trong dropdown
                // =========================
                items.forEach(item => {
                    item.addEventListener('click', () => {
                    item_header.innerHTML = item.innerHTML + "<i class='fa fa-chevron-down'></i>";
                    });
                });

                // =========================
                // Thêm quà & render
                // =========================
                function resetGiftList() {
                    gifts = [];
                    percentage = 0;
                    gift_list.innerHTML = '';
                    document.querySelector('#total-percentage').textContent = '0%';
                    drawWheel();
                }
                
                function updateGiftList() {
                    const mappingImg = {
                        'Thẻ giảm giá': 'icons8-voucher-20.png',
                        'Điện thoại': 'mobile.png',
                        'Khác': 'icons8-other-20.png'
                    }   
                    gift_list.innerHTML = '';
                    gifts.forEach(gift => {
                        const gift_item_html = `
                        <div class="gift-item">
                            <div class="gift-container">
                            <img src="${mappingImg[gift.type]}" alt="">
                            <div class="info">
                                <p class="gift-item-name">${gift.name}</p>
                                <p class="gift-item-percentage">
                                Tỷ lệ: <span class="gift-item-percentage-value">${gift.percentage}%</span>
                                </p>
                            </div>
                            </div>
                            <button class="delete-gift" type="button" aria-label="Xóa">
                            <img src="icons8-trash-20.png" alt="Xóa">
                            </button>
                        </div>
                        `;
                        gift_list.innerHTML += gift_item_html;
                        percentage += gift.percentage;
                    });
                    document.querySelector('#total-percentage').textContent = percentage + '%';
                }

                updateGiftList();

                add_gift_button.addEventListener('click', () => {
                    const gift_name = document.querySelector('.gift-name');
                    const gift_percentage = document.querySelector('.gift-percentage');

                    if (!gift_name.value.trim()) {
                    showToast('Vui lòng nhập tên quà', 'error');
                    return;
                    }
                    if (!gift_percentage.value.trim()) {
                    showToast('Vui lòng nhập tỷ lệ %', 'error');
                    return;
                    }
                    const headerP = item_header.querySelector('p');
                    if (!headerP || headerP.textContent.trim() === 'Vật phẩm') {
                    showToast('Vui lòng chọn loại quà', 'error');
                    return;
                    }

                    gifts.push({
                    name: gift_name.value.trim(),
                    percentage: Number(gift_percentage.value),
                    type: headerP.textContent.trim()
                    });

                    const imgEl = item_header.querySelector('img');
                    const imgHTML = imgEl ? imgEl.outerHTML : '';

                    const gift_item_html = `
                    <div class="gift-item">
                        <div class="gift-container">
                        ${imgHTML || ''}
                        <div class="info">
                            <p class="gift-item-name">${gift_name.value.trim()}</p>
                            <p class="gift-item-percentage">
                            Tỷ lệ: <span class="gift-item-percentage-value">${Number(gift_percentage.value)}%</span>
                            </p>
                        </div>
                        </div>
                        <button class="delete-gift" type="button" aria-label="Xóa">
                        <img src="icons8-trash-20.png" alt="Xóa">
                        </button>
                    </div>
                    `;
                    gift_list.insertAdjacentHTML('beforeend', gift_item_html);
                    percentage += Number(gift_percentage.value);
                    document.querySelector('#total-percentage').textContent = percentage + '%';

                    gift_name.value = "";
                    gift_percentage.value = "";
                    item_header.innerHTML = "<p>Vật phẩm</p><i class='fa fa-chevron-down'></i>";

                    drawWheel();
                    showToast('Đã thêm quà vào danh sách', 'success', 2000);
                });

                // Xóa quà
                gift_list.addEventListener('click', (e) => {
                    const btn = e.target.closest('.delete-gift');
                    if (!btn) return;
                    const item = btn.closest('.gift-item');
                    if (!item) return;

                    const name = item.querySelector('.gift-item-name')?.textContent?.trim();
                    const pctText = item.querySelector('.gift-item-percentage-value')?.textContent?.trim() || "0%";
                    const pct = Number(pctText.replace('%',''));

                    const idx = gifts.findIndex(g => g.name === name && Number(g.percentage) === pct);
                    if (idx > -1) gifts.splice(idx, 1);

                    item.remove();
                    drawWheel();
                    showToast('Đã xóa quà', 'success', 1800);
                    percentage -= pct;
                    document.querySelector('#total-percentage').textContent = percentage + '%';
                });

                reset_gift_button.addEventListener('click', resetGiftList);

                // =========================
                // Helper màu + easing
                // =========================
                // ==== PALETTE ENGINE (OKLCH) ====
                // Giữ nguyên 2 helper cũ của bạn:
                const lerp = (a, b, t) => a + (b - a) * t;
                function lerpHue(h1, h2, t) {
                let d = ((h2 - h1 + 540) % 360) - 180;
                return (h1 + d * t + 360) % 360;
                }

                // Tạo dải màu quanh baseHue (analogous)
                function makeAnalogous(n, {baseHue=95, spread=70, l=0.78, c=0.16, wave=0.06}={}) {
                // spread: độ rộng dải hue quanh baseHue (độ)
                const arr = [];
                for (let i = 0; i < n; i++) {
                    const t = (n === 1) ? 0.5 : i / (n - 1);
                    const h = (baseHue - spread/2) + t*spread;
                    // tạo "sọc" sáng/tối xen kẽ giúp lát tách nhau rõ hơn
                    const li = l + ( (i % 2 ? -1 : 1) * wave * 0.5 );
                    const ci = c + ( (i % 2 ? 1 : -1) * wave * 0.4 );
                    arr.push(`oklch(${li.toFixed(3)} ${Math.max(0.01,ci).toFixed(3)} ${((h%360)+360)%360}deg)`);
                }
                return arr;
                }

                // Tạo dải màu kiểu triadic (3 cụm hue)
                function makeTriadic(n, {baseHue=95, l=0.78, c=0.16, wave=0.06}={}) {
                const tri = [baseHue, (baseHue+120)%360, (baseHue+240)%360];
                const arr = [];
                for (let i = 0; i < n; i++) {
                    const h = tri[i % 3];
                    const li = l + ( (i % 2 ? -1 : 1) * wave * 0.5 );
                    const ci = c + ( (i % 2 ? 1 : -1) * wave * 0.4 );
                    arr.push(`oklch(${li.toFixed(3)} ${Math.max(0.01,ci).toFixed(3)} ${h}deg)`);
                }
                return arr;
                }

                // Tạo dải màu đi qua các "stops" (vàng→cam→hồng→đỏ nhẹ)
                function makeStops(n, stops) {
                if (n <= 0) return [];
                const arr = [];
                for (let i = 0; i < n; i++) {
                    const t = n === 1 ? 0 : i / (n - 1);
                    const segT = t * (stops.length - 1);
                    const i0 = Math.floor(segT);
                    const i1 = Math.min(i0 + 1, stops.length - 1);
                    const lt = segT - i0;
                    const l = lerp(stops[i0].l, stops[i1].l, lt);
                    const c = lerp(stops[i0].c, stops[i1].c, lt);
                    const h = lerpHue(stops[i0].h, stops[i1].h, lt);
                    arr.push(`oklch(${l.toFixed(3)} ${c.toFixed(3)} ${h.toFixed(1)}deg)`);
                }
                return arr;
                }

                // === PRESET THEMES khớp UI của bạn ===
                // 1) GOLD THEME (hợp pointer + nút vàng): vàng→cam→hồng→đỏ nhẹ
                const GOLD_STOPS = [
                { l: 0.80, c: 0.15, h: 95  }, // yellow gold
                { l: 0.80, c: 0.17, h: 60  }, // orange
                { l: 0.79, c: 0.16, h: 340 }, // pink
                { l: 0.78, c: 0.15, h: 15  }  // soft red
                ];

                // 2) INDIGO/PURPLE THEME (hợp header #667EEA→#764BA2)
                const INDIGO_STOPS = [
                { l: 0.78, c: 0.14, h: 270 }, // deep indigo
                { l: 0.79, c: 0.15, h: 285 }, // violet
                { l: 0.80, c: 0.16, h: 300 }, // purple
                { l: 0.80, c: 0.16, h: 315 }  // magenta-violet
                ];

                // 3) EMERALD THEME (hợp nút xanh lá #48BB78→#38A169)
                const EMERALD_STOPS = [
                { l: 0.80, c: 0.14, h: 145 }, // emerald green
                { l: 0.80, c: 0.15, h: 160 }, // jade
                { l: 0.80, c: 0.15, h: 175 }, // sea green
                { l: 0.80, c: 0.14, h: 190 }  // teal-ish
                ];

                // HÀM CHÍNH: chọn theme theo nhu cầu
                // options: { theme: 'gold' | 'indigo' | 'emerald' | 'analogous' | 'triadic' | 'brand',
                //            baseHue: number, spread: number, l: number, c: number }
                function getColors(n, options = { theme: 'gold' }) {
                if (n <= 0) return [];

                const { theme='gold' } = options;

                if (theme === 'gold')    return makeStops(n, GOLD_STOPS);
                if (theme === 'indigo')  return makeStops(n, INDIGO_STOPS);
                if (theme === 'emerald') return makeStops(n, EMERALD_STOPS);

                if (theme === 'analogous') {
                    const { baseHue=95, spread=70, l=0.78, c=0.16 } = options;
                    return makeAnalogous(n, { baseHue, spread, l, c });
                }
                if (theme === 'triadic') {
                    const { baseHue=95, l=0.78, c=0.16 } = options;
                    return makeTriadic(n, { baseHue, l, c });
                }
                if (theme === 'brand') {
                    // "brand": cho phép bạn set baseHue = hue thương hiệu (#FFD700 ≈ ~95),
                    //          và chọn spread nhỏ để giữ sự đồng nhất.
                    const { baseHue=95, spread=50, l=0.80, c=0.16 } = options;
                    return makeAnalogous(n, { baseHue, spread, l, c });
                }

                // fallback
                return makeStops(n, GOLD_STOPS);
                }

                const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

                // =========================
                // Xử lý góc theo tỷ lệ
                // =========================
                function computeSlices(data) {
                    if (!data.length) return [];
                    const sum = data.reduce((s, g) => s + (Number(g.percentage) || 0), 0);

                    let angles = [];
                    if (sum <= 0) {
                    const angle = (2 * Math.PI) / data.length;
                    for (let i = 0; i < data.length; i++) angles.push(angle);
                    } else {
                    for (const g of data) {
                        const p = Math.max(0, Number(g.percentage) || 0);
                        angles.push((p / sum) * 2 * Math.PI);
                    }
                    }
                    return angles;
                }

                // =========================
                // Vẽ wheel
                // =========================
                function drawWheel() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (!gifts.length) {
                    ctx.save();
                    ctx.translate(cx, cy);
                    ctx.beginPath();
                    ctx.arc(0, 0, R, 0, 2 * Math.PI);
                    ctx.fillStyle = '#334155';
                    ctx.fill();
                    ctx.restore();
                    return;
                    }

                    const angles = computeSlices(gifts);
                    const colors = getColors(gifts.length, { theme: 'indigo' });

                    ctx.save();
                    ctx.translate(cx, cy);
                    ctx.rotate(rotation);

                    let start = 0;
                    for (let i = 0; i < gifts.length; i++) {
                    const a = angles[i];
                    const mid = start + a / 2;

                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, R, start, start + a);
                    ctx.closePath();
                    ctx.fillStyle = colors[i];
                    ctx.fill();

                    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    ctx.save();
                    ctx.rotate(mid);
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial';
                    ctx.fillText(gifts[i].name, R - 12, 0);
                    ctx.restore();

                    start += a;
                    }

                    ctx.beginPath();
                    ctx.arc(0, 0, 50, 0, 2 * Math.PI);
                    ctx.fillStyle = '#111827';
                    ctx.fill();
                    ctx.restore();
                }

                // =========================
                // Random theo % & góc tâm
                // =========================
                function pickWinnerIndex() {
                    if (!gifts.length) return -1;
                    const weights = gifts.map(g => Math.max(0, Number(g.percentage) || 0));
                    const sum = weights.reduce((s, v) => s + v, 0);
                    if (sum <= 0) return Math.floor(Math.random() * gifts.length);
                    let r = Math.random() * sum;
                    for (let i = 0; i < weights.length; i++) {
                    if (r < weights[i]) return i;
                    r -= weights[i];
                    }
                    return gifts.length - 1;
                }

                function sliceCenters() {
                    const angles = computeSlices(gifts);
                    const centers = [];
                    let start = 0;
                    for (let a of angles) {
                    centers.push(start + a / 2);
                    start += a;
                    }
                    return centers;
                }

                // =========================
                // Animation quay
                // =========================
                const spinBtn = document.getElementById('spin-btn');
                let spinning = false;
                        if (pointerEl) pointerEl.classList.remove('spinning');

                spinBtn.addEventListener('click', async () => {
                    if (spinning) return;
                    if (!gifts.length) {
                    showToast('Hãy thêm quà trước khi quay!', 'error');
                    return;
                    }

                    const totalPct = gifts.reduce((s, g) => s + (Number(g.percentage) || 0), 0);
                    if (totalPct > 0 && Math.abs(totalPct - 100) > 0.001) {
                    const ok = await showConfirmToast(
                        `Tổng tỷ lệ hiện là ${totalPct}%. Vẫn quay với tỷ lệ đã nhập ?`,
                        { confirmText: 'Tiếp tục', cancelText: 'Hủy', type: 'info' }
                    );
                    if (!ok) return;
                    }

                    ensureAudioCtx(); sweep();
                    const winnerIdx = pickWinnerIndex();
                    const centers = sliceCenters();
                    const centerAngle = centers[winnerIdx] || 0;

                    const extraSpins = 5 * 2 * Math.PI;
                    rotation = ((rotation % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                    const target = rotation + ((POINTER_ANGLE - (rotation + centerAngle)) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI) + extraSpins;

                    const duration = 5000; // ms
                    const startTime = performance.now();
                    const rotationStart = rotation;
                    spinning = true;
                    if (pointerEl) pointerEl.classList.add('spinning');

                    let prevRot = rotationStart;
                    let lastTime = startTime;
                    let tickAccum = 0;
                    const tick = (now) => {
                    const t = Math.min(1, (now - startTime) / duration);
                    const eased = easeOutCubic(t);
                    const current = rotationStart + (target - rotationStart) * eased;
                    const dt = now - lastTime; lastTime = now;
                    rotation = current;
                    // Tick cadence based on angular velocity
                    const angVel = Math.abs(rotation - prevRot); prevRot = rotation;
                    // Map velocity -> tick interval (ms)
                    const tickInterval = 40 + Math.max(0, 220 - Math.min(220, angVel * 1200));
                    tickAccum += dt;
                    if (tickAccum >= tickInterval) { tickAccum = 0; beep({freq: 1200, duration: 0.025, type:'square', gain: 0.10}); }

                    drawWheel();
                    if (t < 1) {
                        requestAnimationFrame(tick);
                    } else {
                        spinning = false;
                        if (pointerEl) pointerEl.classList.remove('spinning');
                        rotation = ((rotation % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                        const won = gifts[winnerIdx];
                        showToast(`Bạn trúng: <b>${won.name}</b>`, 'success', 5000);
                        jingleWin();
                    }
                    };

                    requestAnimationFrame(tick);
                });

                // Khởi tạo
                drawWheel();

                // Gợi ý: bạn đang dùng trùng id="gift-input" cho nhiều phần tử → nên đổi id duy nhất.
                </script>
    </body>
</html>